<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel MFE Posicional – Decisão de Entradas</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #001826;
      color: #ffffff;
    }
    header {
      text-align: center;
      padding: 24px 0 8px 0;
      color: #ff9b32;
      font-size: 26px;
      font-weight: bold;
    }
    .subtitulo {
      text-align: center;
      color: #cccccc;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .info {
      text-align: center;
      color: #cccccc;
      font-size: 11px;
      margin-bottom: 20px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto 40px auto;
      background-color: #032235;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
      padding: 12px 16px 20px 16px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #e0e0e0;
      margin-bottom: 8px;
    }
    .badge-online {
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #004d26;
      color: #a6ffb0;
      font-size: 11px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      background-color: #052a3f;
    }
    th, td {
      padding: 6px 8px;
      text-align: center;
    }
    th {
      color: #ff9b32;
      font-weight: bold;
      border-bottom: 1px solid #18445d;
    }
    tbody tr:nth-child(even) {
      background-color: #041f31;
    }
    tbody tr:nth-child(odd) {
      background-color: #032235;
    }
    .verde {
      color: #00ff7f;
      font-weight: bold;
    }
    .vermelho {
      color: #ff4d4d;
      font-weight: bold;
    }
    .amarelo {
      color: #ffd966;
      font-weight: bold;
    }
    .cinza {
      color: #c0c0c0;
    }
    .rodape-info {
      margin-top: 6px;
      text-align: right;
      font-size: 11px;
      color: #b0b0b0;
    }
  </style>
</head>
<body>
  <header> Painel MFE Posicional – Decisão de Entradas </header>

  <div class="subtitulo">
    PAR · SIDE · PREÇO · ALVO · GANHO % · ZONA · RISCO · PRIORIDADE · DATA · HORA
  </div>
  <div class="info">
    Modo: POSICIONAL (1D) · Atualização automática a cada 5 minutos<br/>
    Este painel mostra TODAS as moedas (LONG, SHORT ou NÃO ENTRAR) gerado pelo MFE.
  </div>

  <div class="container">
    <div class="top-bar">
      <div>Fonte: entrada.json (modo POSICIONAL do Autotrader)</div>
      <div class="badge-online" id="status-api">• Automação conectada</div>
    </div>

    <table>
      <thead>
        <tr>
          <th>PAR</th>
          <th>SIDE</th>
          <th>PREÇO</th>
          <th>ALVO</th>
          <th>GANHO %</th>
          <th>ZONA</th>
          <th>RISCO</th>
          <th>PRIORIDADE</th>
          <th>DATA</th>
          <th>HORA</th>
        </tr>
      </thead>
      <tbody id="tabela-posicional">
        <tr>
          <td colspan="10" class="cinza">Carregando dados...</td>
        </tr>
      </tbody>
    </table>

    <div class="rodape-info" id="info-atualizacao">
      Aguardando primeira atualização...
    </div>
  </div>

  <script>
    async function carregarPainel() {
      const corpo = document.getElementById("tabela-posicional");
      const info = document.getElementById("info-atualizacao");
      const statusApi = document.getElementById("status-api");

      try {
        const resp = await fetch("/api/mfe?ts=" + Date.now());
        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }
        const data = await resp.json();

        const lista = data.posicional || [];
        const ultima = data.ultima_atualizacao || "";

        corpo.innerHTML = "";

        if (lista.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.className = "cinza";
          td.textContent = "Nenhuma moeda com sinal LONG/SHORT neste ciclo. Aguardando próxima atualização...";
          tr.appendChild(td);
          corpo.appendChild(tr);
        } else {
          lista.forEach(item => {
            const tr = document.createElement("tr");

            const tdPar = document.createElement("td");
            tdPar.textContent = item.par || "-";
            tr.appendChild(tdPar);

            const tdSide = document.createElement("td");
            tdSide.textContent = item.side || "-";
            if (item.side === "LONG") tdSide.className = "verde";
            else if (item.side === "SHORT") tdSide.className = "vermelho";
            tr.appendChild(tdSide);

            const tdPreco = document.createElement("td");
            tdPreco.textContent = (item.preco ?? 0).toFixed(3);
            tr.appendChild(tdPreco);

            const tdAlvo = document.createElement("td");
            tdAlvo.textContent = (item.alvo ?? 0).toFixed(3);
            tr.appendChild(tdAlvo);

            const tdGanho = document.createElement("td");
            tdGanho.textContent = (item.ganho_pct ?? 0).toFixed(2) + " %";
            if (item.ganho_pct >= 0) tdGanho.className = "verde";
            else tdGanho.className = "vermelho";
            tr.appendChild(tdGanho);

            const tdZona = document.createElement("td");
            tdZona.textContent = item.zona || "-";
            if (item.zona === "VERDE") tdZona.className = "verde";
            else if (item.zona === "VERMELHA") tdZona.className = "vermelho";
            else tdZona.className = "amarelo";
            tr.appendChild(tdZona);

            const tdRisco = document.createElement("td");
            tdRisco.textContent = item.risco || "-";
            if (item.risco === "BAIXO") tdRisco.className = "verde";
            else if (item.risco === "ALTO") tdRisco.className = "vermelho";
            tr.appendChild(tdRisco);

            const tdPrioridade = document.createElement("td");
            tdPrioridade.textContent = item.prioridade || "-";
            if (item.prioridade === "ALTA") tdPrioridade.className = "verde";
            else if (item.prioridade === "MÉDIA") tdPrioridade.className = "amarelo";
            else if (item.prioridade === "NÃO OPERAR") tdPrioridade.className = "vermelho";
            tr.appendChild(tdPrioridade);

            const tdData = document.createElement("td");
            tdData.textContent = item.data || "-";
            tr.appendChild(tdData);

            const tdHora = document.createElement("td");
            tdHora.textContent = item.hora || "-";
            tr.appendChild(tdHora);

            corpo.appendChild(tr);
          });
        }

        if (ultima) {
          info.textContent = "Atualizado via /api/mfe – Último registro: " + ultima;
        } else {
          info.textContent = "Atualizado via /api/mfe.";
        }

        statusApi.textContent = "• Automação conectada";
        statusApi.style.backgroundColor = "#004d26";
        statusApi.style.color = "#a6ffb0";

      } catch (e) {
        corpo.innerHTML = "";
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 10;
        td.className = "vermelho";
        td.textContent = "Erro ao carregar /api/mfe. Verifique o serviço do painel.";
        tr.appendChild(td);
        corpo.appendChild(tr);

        info.textContent = "Falha ao atualizar via /api/mfe.";
        statusApi.textContent = "• Automação desconectada";
        statusApi.style.backgroundColor = "#661111";
        statusApi.style.color = "#ffcccc";
      }
    }

    // primeira carga + atualização a cada 60s (teste)
    carregarPainel();
    setInterval(carregarPainel, 300000);
  </script>
</body>
</html>
